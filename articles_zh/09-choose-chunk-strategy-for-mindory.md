# Mindory chunk 策略选型


## 前言

为何 Mindory 刻意采用 **基于 Character** 的分块方式 ?

## 1. Mindory 的产品定位
Mindory 并非一个通用型的 RAG 问答项目。
它是一套**本地优先、面向阅读**的系统，产品立场非常明确：

- 以**书籍**为中心，而非各类数据源 ( 各类文档 / 数据库 )
- 以**阅读体验**为核心，而非仅做问答
- 强调 **AI 理解** 与 **原文位置** 的强绑定
- 工程优先级：**确定性、可追溯、可测试**

这一定位带来了一条不可妥协的要求：

> **每一个 Embedding chunk，都必须强关联、精确定位回原始文本**

- 不是近似匹配
- 不是启发式推断

而是**完全确定、可复现**的映射。

仅这一条要求，就已经排除了许多 “理论上更优” 的 chunk 策略。

---

## 2. 为什么分块至关重要
分块存在的唯一目的：

> 为 Embedding Model 提供**大小合理的语义窗口**。

分块**不负责**：
- 最终回答质量
- 用户理解效果
- 叙事连贯性

这些能力由以下能力保证：
- chunk overlap
- Top-k aggregation 
- LLM

在权衡方案时，这一区分至关重要。

---

## 3. 三种主流分块策略
我们将在 **Mindory 的真实约束下**（而非抽象理论中）评估三种典型方案。

---

## 4. 基于句子 / 词语的分块
### 核心思路
- 按句子或词语切分文本
- 每个分块 “语义完整”
- 在 NLP 中非常流行

### 隐藏代价
#### 1. 丧失确定性
句子边界在以下场景中**不具备确定性**：
- 不同写作风格
- 不同语言
- 小说、诗歌、佛经
- OCR 生成的残缺或乱码文本

即便是 “简单” 的英文分句，也很快会退化为启发式规则。

#### 2. 破坏可追溯性
Mindory 要求清晰的映射关系：

```
processed_text_char_index → original_text_char_offset
```

感知句子的分块会带来：
- 变长分块
- 非线性偏移
- 跨边界合并与拆分

这会让**精准高亮、跳转、溯源**变得异常困难 ( 比如意识流小说的句子非常长 )。

#### 3. 用户收益不明显
用户不直接阅读原始分块。
他们看到的是：
- LLM 生成的回答
- 高亮后的原文

基于 NLP 理论构建的完美 “句子”，**并不会让阅读体验提升**。

### 结论
- 与 Mindory 的**确定性**原则冲突
- 降低可追溯性
- 工程复杂度增加，却无明显用户收益

---

## 5. 基于 Tokenizer 的分块
### 核心思路
- 按 Model token 而非字符分块
- 与 Embedding Model “理解文本”的方式对齐

### 现实问题
#### 1. Token ≠ 字符 ≠ 原文
分词器会引入一套全新坐标系：
- Token 与字符无法干净映射
- 特殊 token、空格处理、文本归一化
- Embedding Model 专属行为

这直接破坏了 Mindory 依赖的**单调、干净的位置映射**。

#### 2. 架构污染
Mindory 的设计原则：

> **Embedding Model 可替换，Pipeline 保持稳定。**

基于 token 的分块将其颠倒：
- Pipeline 与 Model 强绑定
- 分词器选择渗透到导入流程
- 更换模型风险大幅上升

#### 3. 实际收益边际化
在真实 RAG 场景中, 分词级别的精度，在产品层面几乎不会带来可感知的提升。

### 结论
- 破坏文本可追溯性
- 与 Embedding Model 耦合
- 用户可感知收益小

---

## 6. 基于 Character 的分块

Mindory 的最终选择

### 核心思路
- 基于 utf8 Character 的**固定长度**
- 中英文通用
- 简单、可控的 overlap 机制 ( 中英文配置有差异 )

### 为何对 Mindory 格外有效
#### 1. 完美可追溯
字符偏移量具备：
- 稳定性
- 语言中立
- 可直接映射回原文

这支撑了：
- 精准高亮
- 可靠跳转
- 可信引用溯源

#### 2. 行为完全确定
相同输入 → 相同分块
无启发式规则，无 NLP 歧义。

对以下场景极具价值：
- 测试
- 调试
- 长期维护

#### 3. “足够好”的语义效果
Embedding Model 并不要求：
- 完美句子边界
- 语言学纯净度

它们只需要：
- 足够上下文
- 合理长度
- Overlap 带来的上下文连续性

基于字符的分块完全满足这三点。

---

## 7. 这会影响 AI 理解能力吗？
简短回答：**不会。**

详细解释：
- 检索会同时使用多个分块
- Overlap 平滑了边界切割
- LLM 会整体重构语义

用户感知不到分块边界，
他们只感知**回答与高亮段落**。

只要分块满足：
- 不过短
- 不孤立
- Overlap 合理

对语义的影响几乎可以忽略。

---

## 8. 总结
Mindory 的 chunk 策略看似简单，但并非随性而为，而是一次**深思熟虑的工程决策**，完全对齐：

- 产品目标
- 用户体验完整性
- 架构简洁性

> **在 Mindory 中，可追溯是头等大事。
> 智能，是之后的事情。**